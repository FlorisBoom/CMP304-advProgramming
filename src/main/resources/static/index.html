<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="//stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <title>Home</title>
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>

<div class="vertical-container">
    <!-- Select flight day and airport -->
    <div class="container">
        <div class="row">
            <div class="col offset padding">
                <div class="center">
                    <h1 class="small-h1">Select Your Flight Day and Airport:</h1>
                    <form>
                        <div class="form-group">
                            <label for="dayInput">Flight Day:</label>
                            <input type="date" class="form-control" id="dayInput" value="2020-02-29" required>
                        </div>
                        <div class="form-group">
                            <label for="airportSelect">Airport:</label>
                            <select id="airportSelect" class="form-control">
                                <option value="newcastle">Newcastle</option>
                                <option value="amsterdam">Amsterdam</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <input type="button"  class="btn btn-success" value="Next" onclick="getFlights(); next(this);">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Display flights -->
    <div class="container disabled">
        <div class="row">
            <div class="col offset padding">
                <div class="center">
                    <h1 class="small-h1">Available Flights:</h1>
                    <form>
                        <div class="form-group card-container">

                        </div>
                    </form>
                    <input type="button" class="btn btn-danger" value="Back" onclick="back(this); removeFlights();">
                </div>
            </div>
        </div>
    </div>

    <!-- User information + flight seat -->
    <div class="container disabled">
        <div class="row">
            <div class="col offset padding">
                <div class="center">
                    <h1 class="small-h1">Enter your personal details.</h1>
                    <h3 id="price"> </h3>
                    <form id="payment-form">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="firstName">First name:</label>
                                <input type="text" class="form-control" id="firstName" required />
                            </div>
                            <div class="form-group col-md-6">
                                <label for="lastName">Last name:</label>
                                <input type="text" class="form-control" id="lastName" required />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" class="form-control" id="email" required />
                        </div>
                        <div class="form-group">
                            <label for="email">Choose seat:</label>
                            <select id="seatSelect" class="form-control">
                            </select>
                        </div>
                        <div id="card-element">

                        </div>
                        <div id="card-errors" role="alert"></div>
                        <input type="hidden" id="flightId" value="" />
                        <input type="button" class="btn btn-danger" onclick="back(this);" value="Back"/>
                        <input type="button" class="btn btn-success" onclick="bookFlight();" value="Book"/>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking + potentional updates -->
    <div class="container disabled">
        <div class="row">
            <div class="col offset padding">
                <div class="center">
                    <h1 class="small-h1">Booking confirmation.</h1>
                    <p>Thank you for booking this flight. A confirmation e-mail, including your ticket has been sent to you.
                        The e-mail includes your booking order number, which can be used to find your booked flight and update details.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!--
TODO: Stripe afmaken, prijs overal bekend maken, email sturen met code die in bookings word opgeslagen om je booking op de homepagina te vinden
TODO: Login maken voor werknemers om alle vluchten in te zien
-->

<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script>

    var stripe = Stripe('pk_test_J2kCgWmod3DVyCRNIOoyb2zt00YX8RBCE4');
    var elements = stripe.elements();

    var style = {
        base: {
            color: "#32325d",
        }
    };

    var card = elements.create("card", { style: style });
    card.mount("#card-element");

    card.on('change', ({error}) => {
        const displayError = document.getElementById('card-errors');
        if (error) {
            displayError.textContent = error.message;
        } else {
            displayError.textContent = '';
        }
    });

    function next(currentCard) {
        if( $(currentCard.closest( ".container" )).find( "input" ).val().length !== 0 ) {
            $(currentCard.closest( ".container" )).fadeOut( "fast", function () {
                $(currentCard.closest( ".container" )).next( ".container" ).fadeIn( "fast", function () {});
            });
        }
    }

    function back(currentCard) {
        $(currentCard.closest( ".container" )).fadeOut( "fast", function () {
            $(currentCard.closest( ".container" )).prev( ".container" ).fadeIn( "fast", function () {});
        });
    }

    function removeFlights() {
        $( ".card-container" ).empty();
    }

    function setFlightIdAndSeats(button) {
        const flightId = $(button.closest( ".container" )).find( "input[type=hidden]" ).val();
        const seatSelect = document.getElementById("seatSelect")
        let seats = []
        $.ajax({
            url: "/flight/"+flightId,
            type: "get",
            success: function (data) {
                seats = data[flightId].availSeats
                console.log(data[flightId].price)
                $('#price').html('Price: ' + 'â‚¬' + data[flightId].price)
                for( let i = 0; i <  seats.length; i++ ) {
                    let option = seats[i]
                    let el = document.createElement( "option" )
                    el.textContent = option
                    el.value = option
                    seatSelect.appendChild(el)
                }
            },
            error: function (err) {
                console.error(err)
            }
        })
        $( "#flightId" ).val(flightId);
    }

    function getFlights() {

        const date = new Date($("#dayInput").val());
        const airport = $("#airportSelect option:selected").text();

        $.ajax({
            url: "/flights/" + date + "/" + airport,
            type: "get",
            success: function (data) {
                const container = $(".card-container");
                let card, cardBody, cardTitle, cardText, cardButton, date;
                for (let k in data) {
                    date = new Date(data[k].departureDate.seconds * 1000);
                    card = $("<div>").addClass("card").appendTo(container);
                    cardBody = $("<div>").addClass("card-body").appendTo(card);
                    cardTitle = $("<h5>").addClass("card-title").html(data[k].takeOff + " - " + data[k].destination).appendTo(cardBody);
                    cardText = $("<p>").addClass("card-text").html("<b>Departure:</b> " + date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear() + "     " + data[k].departureTime + " <b>Flight length:</b> " + data[k].duration).appendTo(cardBody);
                    cardButton = $("<input type='button' onclick='next(this); setFlightIdAndSeats(this);'>").addClass("btn btn-success").val("Book flight").appendTo(cardBody);
                    $("<input type='hidden'>").val(k).appendTo(cardBody);
                }
            },
            error: function () {
                console.log("woops something went wrong")
            }
        })
    }

    function bookFlight() {

        const firstName = $( "#firstName" ).val();
        const lastName = $( "#lastName" ).val();
        const email = $( "#email" ).val();
        const flightId = $( "#flightId" ).val();
        const seat = $( "#seatSelect" ).val();

        $.ajax({
            url: "/book",
            type: "post",
            data: {firstName: firstName, lastName: lastName, email: email, seat: seat, flightId: flightId},
            success: function (data) {
                console.log(data);
            },
            error: function () {
                console.log( "whoops" )
            }
        });
    }

</script>

</body>
</html>